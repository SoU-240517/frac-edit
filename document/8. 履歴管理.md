[[機能要求書]]
***

### 8.1. 操作履歴の記録

- **概要:**  
  ユーザーが行った操作（例: パラメータの変更、描画モードの選択、フィルターの適用など）を時系列で記録します。これにより、ユーザーは過去の状態に簡単に戻ることができ、安心して試行錯誤を行いながら創作活動に集中できます。

- **記録対象:**  
  以下の操作が履歴として記録されます:  
  - パラメータの変更（数値、式、選択肢など）  
  - 描画モード、フィルター、エフェクトの選択およびそのパラメータの調整  
  - グラデーションの編集（色点の追加・削除・移動、色の変更など）  
  - 背景グラデーションの設定  
  - キャンバスのパンやズーム操作  
  - フラクタルタイプの追加・削除、影響関係の設定（ノード編集）

- **記録のタイミング:**  
  - パラメータの変更: 編集が確定した時点（例: 入力フィールドのフォーカスアウト、スライダーの操作終了）  
  - キャンバスのパンやズーム: 操作が完了した時点（例: マウスボタンを離したタイミング）  
  - ノード編集: ノードの追加・削除・接続の変更が確定した時点

- **履歴の管理:**  
  - 履歴はスタック形式で管理され、最大履歴数（例: 100ステップ）が設定されます。  
  - 最大数に達した場合、最も古い履歴から順に削除されます。  
  - 履歴はプロジェクトファイルに保存され、読み込み時に復元可能です。

---

### 8.2. アンドゥ/リドゥ機能

- **概要:**  
  アンドゥ（元に戻す）とリドゥ（やり直し）機能を提供し、ユーザーが過去の操作を取り消したり、取り消した操作を再実行したりできるようにします。これにより、誤操作や試行錯誤による変更を簡単に修正できます。

- **機能:**  
  - **アンドゥ:**  
    - 直前の操作を取り消し、1つ前の状態に戻ります。  
    - 連続操作で履歴を遡ることが可能です。  
  - **リドゥ:**  
    - アンドゥで取り消した操作を再度実行し、1つ先の状態に戻ります。  
    - 連続操作で取り消した操作を順に再実行できます。

- **操作方法:**  
  - **キーボードショートカット:**  
    - アンドゥ: `Ctrl + Z`  
    - リドゥ: `Ctrl + Y` または `Ctrl + Shift + Z`  
  - **メニュー:**  
    - 「編集」メニューに「元に戻す」「やり直し」項目を配置し、クリックで実行可能。  
  - **ツールバー:**  
    - メインウィンドウ上部にアンドゥ/リドゥボタンを設置し、クリックで実行可能。

- **状態の反映:**  
  - アンドゥ/リドゥ実行後、キャンバスの描画が即時に更新され、現在の状態が反映されます。  
  - パラメータパネルやグラデーションエディタなどのUIも現在の状態に同期します。

- **制限:**  
  - アンドゥ/リドゥは履歴の範囲内でのみ実行可能です。  
  - 履歴が最大数に達した場合、最も古い状態には戻れません。  
  - プロジェクトの保存や読み込み操作は履歴に記録されず、アンドゥ/リドゥの対象外です。

---

### 共通仕様

- **リアルタイム反映:**  
  - アンドゥ/リドゥ操作後、キャンバスやUIに即時反映され、ユーザーが操作結果を直ちに確認できます。

- **保存と読み込み:**  
  - 履歴はプロジェクトファイルに含まれ、読み込み時に復元されます。  
  - 履歴の保存はオプションで、ユーザーが設定画面（例: 「履歴を保存する」チェックボックス）で選択可能です。

- **エラーハンドリング:**  
  - 履歴が空の場合や最大数に達した場合、アンドゥ/リドゥボタンを無効化し、操作不可を示します。  
  - 履歴復元に失敗した場合（例: ファイル破損）、エラーメッセージ（例: 「履歴の復元に失敗しました。プロジェクトを再読み込みしてください。」）を表示します。

- **パフォーマンス:**  
  - 履歴の記録と復元は迅速に実行され、操作感を損ないません。  
  - キャンバスの再描画は簡易描画モードで効率化し、リアルタイム性を確保します。

---
