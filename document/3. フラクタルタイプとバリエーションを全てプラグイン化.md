[[機能要求書]]
***

## 概要

本フラクタルエディタでは、フラクタルタイプとバリエーションをプリセットとして固定せず、すべてプラグインとして実装することで、ユーザーが新たなフラクタルタイプを追加・カスタマイズできる柔軟性と拡張性を確保します。プラグインは Python で記述され、所定のインターフェースに準拠することでエディタに統合されます。

## 目的

- **拡張性の確保:**  
    ユーザーが独自のフラクタルアルゴリズムを容易に追加できるようにする。
    
- **多様性の提供:**  
    初期実装に依存せず、コミュニティや開発者が新しいフラクタルタイプを共有できる環境を構築する。
    
- **保守性の向上:**  
    コア機能とフラクタル生成ロジックを分離することで、メンテナンスや改良が容易になる。
    
## プラグインの仕様

- **実装言語:**  
    プラグインは Python を使用して実装され、Python モジュール（.py ファイル）として提供されます。
    
- **インターフェース:**  
    各プラグインは、エディタとの統合のために以下のメソッドを実装する必要があります。
    
    - `initialize()`:  
        プラグインの初期化処理を行い、必要なリソースの確保や設定を実施します。
    - `render(x, y, params)`:  
        指定された座標 (x, y) とパラメータ (params) に基づき、フラクタルの描画に必要な値（または描画結果）を返します。
    - `get_params()`:  
        編集可能なパラメータのリスト、各パラメータのデフォルト値、許容範囲などの情報を返します。

- **ファイル形式:**  
    プラグインは `.py` ファイルとして保存され、所定のプラグインフォルダに配置することで、エディタが自動的に認識・読み込みします。
    
- **依存ライブラリ:**  
    NumPy や SciPy など、フラクタル計算に必要な外部ライブラリの使用が可能です。必要な依存関係は `requirements.txt` により管理されます。
    
## プラグインの種類（初期提供例）

以下は、初期実装で提供を想定するプラグインの例です。
テスト段階では「テスト実装」のみを導入します。

### フラクタルタイプ
#### 1. Julia/Mandelbrot集合（テスト実装）

- **概要:**  
    複素平面上で Julia 集合を生成します。ユーザーは複素数パラメータ（例: c = -0.8 + 0.156i）を指定可能です。
- **パラメータ:**
    - `c_real`: 複素数 c の実数部（範囲: -2.0 ～ 2.0）
    - `c_imag`: 複素数 c の虚数部（範囲: -2.0 ～ 2.0）
    - `z_real`: 複素数 z の実数部（範囲: -2.0 ～ 2.0）
    - `z_imag`: 複素数 z の虚数部（範囲: -2.0 ～ 2.0）
    - `max_iter`: 最大反復回数（範囲: 10 ～ 1000、デフォルト: 100）
- **計算式:**  
    zn+1=zn2+cz_{n+1} = z_n^2 + c  
    （初期値 z0z_0 はキャンバス座標に対応）
- **特徴:**  
    古典的なフラクタルで、カラーリングやズームにより多様な視覚効果が得られます。

#### 2. Sierpinskiの三角形

- **概要:**  
    再帰的に三角形を分割するシンプルなフラクタルを生成します。
- **パラメータ:**
    - `depth`: 再帰の深さ（例: 5）
- **計算式:**  
    初期三角形を3つの小三角形に分割し、これを再帰的に繰り返す。
- **特徴:**  
    再帰的な構造が明快で、教育的な例としても有用です。

#### 3. Newtonフラクタル

- **概要:**  
    Newton-Raphson 法を用いて多項式の根を視覚化し、複雑な境界を持つフラクタルを生成します。
- **パラメータ:**
    - `degree`: 多項式の次数（例: 3）
    - `max_iter`: 最大反復回数（例: 20）
- **計算式:**  
    例として、f(z)=zdegree−1f(z) = z^{\text{degree}} - 1 とし、  
    zn+1=zn−f(zn)f′(zn)z_{n+1} = z_n - \frac{f(z_n)}{f'(z_n)}
- **特徴:**  
    根ごとに領域が色分けされ、境界に複雑な模様が現れます。

### バリエーション（Apophysisプラグイン同等）
#### 1. Linear（テスト実装）

- **概要:**  
    単純なアフィン変換を適用し、基本的な変形を行います。
- **パラメータ:**
    - `a, b, c, d, e, f`: アフィン変換行列の係数（例: x′=ax+by+e,  y′=cx+dy+fx' = ax + by + e, \; y' = cx + dy + f）
    - `weight`: 変形の適用確率（範囲: 0.0 ～ 1.0、デフォルト: 1.0）
- **特徴:**  
    シンプルな変換を用い、他の変形との組み合わせで複雑なパターンが生成可能です。

#### 2. Spherical

- **概要:**  
    点の距離を反転させる非線形変換により、球面効果を再現します。
- **パラメータ:**
    - `strength`: 変換の強度（範囲: 0.1 ～ 10.0、デフォルト: 1.0）
    - `weight`: 適用確率
- **計算式:**  
    r2=x2+y2r^2 = x^2 + y^2 に対し、  
    (x′,y′)=strength×(xr2,yr2)(x', y') = \text{strength} \times \left(\frac{x}{r^2}, \frac{y}{r^2}\right)
- **特徴:**  
    独特の歪みを生み出し、視覚的にインパクトのあるパターンを生成します。

#### 3. Swirl

- **概要:**  
    渦巻き状のパターンを生成する変形です。
- **パラメータ:**
    - `radius`: 渦の半径（範囲: 0.1 ～ 5.0、デフォルト: 1.0）
    - `weight`: 適用確率
- **計算式:**  
    (x′,y′)=(xcos⁡(r)−ysin⁡(r),  xsin⁡(r)+ycos⁡(r))(x', y') = (x \cos(r) - y \sin(r), \; x \sin(r) + y \cos(r))  
    （ただし、rr は入力座標における距離を適宜計算）
- **特徴:**  
    回転効果により複雑なパターンを生み出し、有機的なデザインが期待できます。

#### 4. JuliaN

- **概要:**  
    Julia 集合の一般化版。べき乗数を可変にして、多様な形状を生成します。
- **パラメータ:**
    - `power`: べき乗数（範囲: 2 ～ 10、デフォルト: 2）
    - `c_real`, `c_imag`: Julia 集合と同様のパラメータ
    - `max_iter`: 最大反復回数
- **計算式:**  
    zn+1=znpower+cz_{n+1} = z_n^{\text{power}} + c
- **特徴:**  
    べき乗数の調整により、従来の Julia 集合とは異なるバリエーションを実現します。

#### 5. Sinusoidal

- **概要:**  
    波状のパターンを生成する非線形変換です。
- **パラメータ:**
    - `frequency`: 波の周波数（例: 1.0）
    - `weight`: 適用確率
- **計算式:**  
    (x′,y′)=(sin⁡(frequency⋅x),  sin⁡(frequency⋅y))(x', y') = (\sin(\text{frequency} \cdot x), \; \sin(\text{frequency} \cdot y))
- **特徴:**  
    柔らかな曲線や波打つ効果を生み出し、視覚的に優しい印象を与えます。

#### 6. Polar

- **概要:**  
    極座標系への変換を行い、円形や渦巻きのパターンを強調します。
- **パラメータ:**
    - `strength`: 変換の強度（例: 1.0）
    - `weight`: 適用確率
- **計算式:**  
    r=x2+y2,θ=arctan⁡2(y,x)r = \sqrt{x^2 + y^2}, \quad \theta = \arctan2(y, x)  
    (x′,y′)=(θπ,  r−1)(x', y') = \left(\frac{\theta}{\pi}, \; r - 1\right)
- **特徴:**  
    放射状のデザインを生み出し、他の変形との組み合わせで多彩な効果を発揮します。

## エラーチェックと管理

- **プラグイン検証:**  
    エディタ起動時にプラグインフォルダをスキャンし、各プラグインが所定のインターフェース（`initialize()`, `render()`, `get_params()`）を正しく実装しているか検証します。  
    インターフェースに準拠していないプラグインは、読み込みエラーとしてユーザーに通知されるか、無効化されます。
    
- **依存ライブラリ管理:**  
    プラグインが必要とする外部ライブラリは、`requirements.txt` で管理し、エディタのインストール時またはプラグイン読み込み時にチェックされます。
    
---
